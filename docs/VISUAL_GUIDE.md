# SPG Visual Guide & Diagrams

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SPG Framework                               â”‚
â”‚                     (Soccer Path Generator)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   SPGState (d)          â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚ Input            â”‚   â”‚ â† Robot pose, ball, obstacles
                    â”‚  â”‚ Target           â”‚   â”‚ â† Final goal
                    â”‚  â”‚ Subtarget        â”‚   â”‚ â† Intermediate waypoint
                    â”‚  â”‚ Setpoint         â”‚   â”‚ â†’ Output (position, velocity)
                    â”‚  â”‚ Trajectory       â”‚   â”‚ â†’ Predicted path
                    â”‚  â”‚ Parameters       â”‚   â”‚ â† use_humanoid_mpc flag
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                        â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Target::Set() â”‚      â”‚Subtarget::Set()â”‚      â”‚setpoint::Set() â”‚
â”‚               â”‚      â”‚                â”‚      â”‚                â”‚
â”‚ â€¢ Field adj   â”‚      â”‚ â€¢ Collision    â”‚      â”‚ â€¢ Mode select  â”‚
â”‚ â€¢ Obstacle adjâ”‚â”€â”€â”€â”€â”€â”€â–¶â”‚   checking     â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ â€¢ MSL / MPC    â”‚
â”‚ â€¢ 3m rule     â”‚      â”‚ â€¢ Replan       â”‚      â”‚ â€¢ Control gen  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚                               â”‚
                                        â–¼                               â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚   MSL Mode        â”‚         â”‚  HumanoidMPC Mode â”‚
                            â”‚                   â”‚         â”‚                   â”‚
                            â”‚ â€¢ GetSegments()   â”‚         â”‚ â€¢ Transform goal  â”‚
                            â”‚ â€¢ Traj1()         â”‚         â”‚   (globalâ†’local)  â”‚
                            â”‚ â€¢ TrajPredict()   â”‚         â”‚ â€¢ Solve QP        â”‚
                            â”‚                   â”‚         â”‚ â€¢ Transform back  â”‚
                            â”‚ âš¡ Fast (~200Î¼s)  â”‚         â”‚   (localâ†’global)  â”‚
                            â”‚ âœ“ Proven          â”‚         â”‚ ğŸ¯ Optimal (~2ms) â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## MPC Control Loop in Detail

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MPC Control Cycle (50 Hz)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  1. Get Current State (Global)  â”‚
            â”‚  â€¢ Position: [x, y, Ï†]          â”‚
            â”‚  â€¢ Velocity: [vx, vy, Ï‰]        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  2. Transform to Local Frame    â”‚
            â”‚                                 â”‚
            â”‚  Goal (global)                  â”‚
            â”‚    â†“ Rotation by -Ï†             â”‚
            â”‚  Goal (local) = [x_fwd, y_lat]  â”‚
            â”‚                                 â”‚
            â”‚  Velocity (global)              â”‚
            â”‚    â†“ Rotation by -Ï†             â”‚
            â”‚  u_meas = [vf, vs, Ï‰]           â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  3. MPC Optimization (Local)    â”‚
            â”‚                                 â”‚
            â”‚  Current: xâ‚€ = [0, 0, 0]        â”‚
            â”‚  Goal:    xg = [x_fwd, y_lat,Ï†] â”‚
            â”‚                                 â”‚
            â”‚  Solve QP:                      â”‚
            â”‚    min  Â½ Å¨áµ€ H Å¨ + fáµ€ Å¨         â”‚
            â”‚    s.t. -1 â‰¤ Å¨ â‰¤ 1              â”‚
            â”‚                                 â”‚
            â”‚  Output: u = [vf, vs, Ï‰]        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  4. Transform to Global Frame   â”‚
            â”‚                                 â”‚
            â”‚  Control (local)                â”‚
            â”‚    â†“ Rotation by +Ï†             â”‚
            â”‚  Control (global) = [vx, vy, Ï‰] â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  5. Apply Control               â”‚
            â”‚  â€¢ Update robot position        â”‚
            â”‚  â€¢ Send to actuators            â”‚
            â”‚  â€¢ Visualize trajectory         â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â±ï¸ Wait 20ms (50 Hz)
                              â”‚
                              â””â”€â”€â”€â”€â”€â”€â”
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â””â”€â”€â–¶ Repeat
```

---

## Coordinate Frame Transformation Visual

```
                    Global (World) Frame
                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                           â†‘ Y
                           â”‚
                    â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â†’ X
                           â”‚
                           â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚              â”‚              â”‚
            â”‚         Goal (xg, yg)       â”‚
            â”‚              â—              â”‚
            â”‚             /â”‚\             â”‚
            â”‚            / â”‚ \            â”‚
            â”‚           /  â”‚  \           â”‚
            â”‚          /   â”‚   \          â”‚
            â”‚         /    â”‚    \         â”‚
            â”‚        /     â”‚     \        â”‚
            â”‚       /      â”‚      \       â”‚
            â”‚      /       â”‚       \      â”‚
            â”‚  Robot â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â†’ Ï†       â”‚
            â”‚    @  (xr, yr)              â”‚
            â”‚    â”‚\                       â”‚
            â”‚    â”‚ \  â† Heading           â”‚
            â”‚    â”‚  \                     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”˜


                    Robot Local (Body) Frame
                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                          â†‘ y (lateral/left)
                          â”‚
                          â”‚
                          â”‚
                   Robot  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â†’ x (forward)
                     @    â”‚
                          â”‚
                          â”‚
                          
            Goal in Local Frame:
            â€¢ x_local =  (xg - xr) cos(Ï†) + (yg - yr) sin(Ï†)
            â€¢ y_local = -(xg - xr) sin(Ï†) + (yg - yr) cos(Ï†)
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                            â”‚
            â”‚        Goal (local)        â”‚
            â”‚           â—                â”‚
            â”‚          /                 â”‚
            â”‚         /                  â”‚
            â”‚        /                   â”‚
            â”‚       /                    â”‚
            â”‚      /                     â”‚
            â”‚     /                      â”‚
            â”‚    /                       â”‚
            â”‚   @  Robot                 â”‚
            â”‚   â”‚  (always at origin)    â”‚
            â”‚   â”‚                        â”‚
            â”‚   â””â”€â”€â†’ facing forward (0Â°) â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## MPC Horizon Visualization

```
Current timestep: k=0
           â†“
    Robot  â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Goal
    @      â”‚                                  â—
           â”‚
           â”œâ”€â–¶ uâ‚€  (vfâ‚€, vsâ‚€, Ï‰â‚€)  â† APPLY THIS
           â”‚
           â–¼
    k=1    â—
           â”‚
           â”œâ”€â–¶ uâ‚  (vfâ‚, vsâ‚, Ï‰â‚)
           â”‚
           â–¼
    k=2    â—
           â”‚
           â”œâ”€â–¶ uâ‚‚  (vfâ‚‚, vsâ‚‚, Ï‰â‚‚)
           â”‚
           â‹®
           â”‚
    k=9    â—
           â”‚
           â”œâ”€â–¶ uâ‚‰  (vfâ‚‰, vsâ‚‰, Ï‰â‚‰)
           â”‚
           â–¼
    k=10   â—  â† Terminal state (should be near goal)

    Horizon N = 10 steps
    Prediction: 10 Ã— 0.02s = 0.2 seconds ahead
    
    At next timestep:
    â€¢ Shift everything forward by 1
    â€¢ Re-solve from new current position
    â€¢ Apply new uâ‚€
    
    This is called "Receding Horizon" control
```

---

## Cost Function Components

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MPC Cost Function                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Total Cost J = J_tracking + J_effort + J_smoothness
    
    
1ï¸âƒ£  TRACKING COST (Want to reach goal)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    Stage cost (each k):
    J_tracking_k = (x_k - x_goal)áµ€ Q (x_k - x_goal)
    
                    Goal
                     â—
                    /â”‚\
                   / â”‚ \
        Q_pos â†’   /  â”‚  \  â† larger = stronger pull
                 /   â”‚   \
                /    â”‚    \
        Robot  â—â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€  Error vector
    
    Terminal cost (k=N):
    J_tracking_N = (x_N - x_goal)áµ€ Qf (x_N - x_goal)
    
    Qf >> Q  (terminal cost much larger to ensure we arrive)
    

2ï¸âƒ£  EFFORT COST (Don't use too much energy)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    J_effort_k = u_káµ€ R u_k
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Control     â”‚
    â”‚   Magnitude   â”‚
    â”‚               â”‚
    â”‚   â†‘           â”‚
    â”‚   â”‚   R â†’     â”‚  â† larger = discourage large controls
    â”‚   â”‚           â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â†’    â”‚
    â”‚   vf    vs    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    Typically: r_vs > r_vf (sideways motion costs more)


3ï¸âƒ£  SMOOTHNESS COST (Avoid jerky motion)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    Î”u_k = u_k - u_{k-1}  (control rate of change)
    
    J_smoothness_k = Î”u_káµ€ S Î”u_k
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Velocity                  â”‚
    â”‚    â†‘                       â”‚
    â”‚    â”‚     â•±â•²                â”‚
    â”‚    â”‚    â•±  â•²               â”‚  S large â†’ smoother
    â”‚    â”‚   â•±    â•²              â”‚
    â”‚    â”‚  â•±      â•²             â”‚  S small â†’ more aggressive
    â”‚    â”‚ â•±        â•²            â”‚
    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Time     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    Special: Î”uâ‚€ = uâ‚€ - u_meas
    (accounts for current velocity to avoid jumps)
```

---

## QP Problem Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Quadratic Program (QP) Formulation                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Decision variables: Å¨ = [Å©â‚€áµ€, Å©â‚áµ€, ..., Å©â‚‰áµ€]áµ€  (30 Ã— 1 vector)
                         â””â”€â”€â”¬â”€â”€â”˜
                    normalized controls [-1, 1]


minimize    Â½ Å¨áµ€ H Å¨ + fáµ€ Å¨
             â””â”€â”¬â”€â”˜   â””â”€â”¬â”€â”˜
          Quadratic  Linear
            term     term

subject to  -1 â‰¤ Å¨ â‰¤ 1  (box constraints)


Matrix dimensions:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  H:  (30 Ã— 30)  Hessian matrix         â”‚
â”‚  f:  (30 Ã— 1)   Gradient vector        â”‚
â”‚  Å¨:  (30 Ã— 1)   Optimization variable  â”‚
â”‚  lb: (30 Ã— 1)   Lower bounds = -1      â”‚
â”‚  ub: (30 Ã— 1)   Upper bounds = +1      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


H is built from:
  H = 2(Suáµ€QbarSu + Rbar + Láµ€SbarL)
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      Tracking     Effort   Smoothness
      
f is built from:
  f = 2(Suáµ€Qbar(SxÂ·xâ‚€ - xgoal) + Láµ€SbarÂ·lâ‚€)
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      Tracking offset       Smoothness offset
                            (measured velocity)


qpOASES solver:
  Input:  H, f, lb, ub
  Output: Å¨*  (optimal normalized controls)
  Time:   ~1-3ms (20-40 iterations)
```

---

## Field Layout & Coordinates

```
                     RoboCup SSL/MSL Field
                     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
         (0, field_y_half)
                 â†‘
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”Œâ”€â”€â”€â”     â”‚     â”Œâ”€â”€â”€â”  â”‚
    â”‚  â”‚   â”‚     â”‚     â”‚   â”‚  â”‚  â† Goals
    â”‚  â””â”€â”€â”€â”˜     â”‚     â””â”€â”€â”€â”˜  â”‚
    â”‚            â”‚            â”‚
    â”‚      Goal  â”‚  Goal      â”‚
    â”‚      Area  â”‚  Area      â”‚
    â”‚            â”‚            â”‚
    â”‚            â”‚            â”‚
    â”‚     Penaltyâ”‚Penalty     â”‚
    â”‚     Area   â”‚   Area     â”‚
    â”‚            â”‚            â”‚
    â”‚            â”‚            â”‚
    â”‚            â—â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚  â† Robot
    â”‚          (x, y)         â”‚
    â”‚            â”‚            â”‚
    â”‚            â”‚            â”‚
    â”‚            â”‚            â”‚
    â”‚            â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
         (0, -field_y_half)
    
    â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
    -field_x_half 0  field_x_half


Typical dimensions:
â€¢ Field: 9m Ã— 6m (MSL) or 12m Ã— 9m (SSL)
â€¢ Goals: 2m wide
â€¢ Border margin: 0.3m
â€¢ Robot radius: 0.18m
```

---

## Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Sensors   â”‚
â”‚  â€¢ Odometry â”‚
â”‚  â€¢ Camera   â”‚â”€â”€â”
â”‚  â€¢ IMU      â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                 â”‚
                 â”œâ”€â”€â–¶ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  Vision/State  â”‚
â”‚   Rules     â”‚  â”‚    â”‚   Estimation   â”‚
â”‚  â€¢ Referee  â”‚â”€â”€â”¼â”€â”€â”€â–¶â”‚                â”‚
â”‚  â€¢ Game     â”‚  â”‚    â”‚  â€¢ Robot pose  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â€¢ Ball        â”‚
                 â”‚    â”‚  â€¢ Obstacles   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  Strategy   â”‚  â”‚             â”‚
â”‚  â€¢ Attack   â”‚â”€â”€â”˜             â”‚
â”‚  â€¢ Defense  â”‚                â–¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   SPG State     â”‚
                     â”‚  (d)            â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  Target::Set()  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚ Subtarget::Set()â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚ setpoint::Set() â”‚
                     â”‚                 â”‚
                     â”‚  MSL or MPC?    â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   MSL Mode     â”‚        â”‚ HumanoidMPC    â”‚
        â”‚                â”‚        â”‚                â”‚
        â”‚ GetSegments    â”‚        â”‚ QP Solver      â”‚
        â”‚ Traj1          â”‚        â”‚ qpOASES        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                         â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  d.setpoint     â”‚
                     â”‚  â€¢ position     â”‚
                     â”‚  â€¢ velocity     â”‚
                     â”‚  â€¢ acceleration â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Visualization â”‚        â”‚  Motor Control â”‚
        â”‚  (ImGui/Plot)  â”‚        â”‚  (Robot HW)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Timing Diagram (50 Hz Loop)

```
    0ms                    20ms                   40ms
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                       â”‚                     â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ Get sensor data â”‚  â”‚  â”‚ Get sensor... â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚         â†“             â”‚        â†“            â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ Target::Set     â”‚  â”‚  â”‚ Target::Set   â”‚ â”‚
    â”‚  â”‚ (~50Î¼s)         â”‚  â”‚  â”‚               â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚         â†“             â”‚        â†“            â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ Subtarget::Set  â”‚  â”‚  â”‚ Subtarget...  â”‚ â”‚
    â”‚  â”‚ (~100Î¼s)        â”‚  â”‚  â”‚               â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚         â†“             â”‚        â†“            â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ setpoint::Set   â”‚  â”‚  â”‚ setpoint::Set â”‚ â”‚
    â”‚  â”‚                 â”‚  â”‚  â”‚               â”‚ â”‚
    â”‚  â”‚ MSL: ~200Î¼s     â”‚  â”‚  â”‚               â”‚ â”‚
    â”‚  â”‚ MPC: ~1-3ms     â”‚  â”‚  â”‚               â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚         â†“             â”‚        â†“            â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ Send to motors  â”‚  â”‚  â”‚ Send to...    â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚         â†“             â”‚        â†“            â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ Update viz      â”‚  â”‚  â”‚ Update viz    â”‚ â”‚
    â”‚  â”‚ (~500Î¼s)        â”‚  â”‚  â”‚               â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚         â†“             â”‚        â†“            â”‚
    â”‚    â±ï¸ Wait            â”‚    â±ï¸ Wait          â”‚
    â”‚    (remainder)        â”‚    (remainder)      â”‚
    â”‚                       â”‚                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Total budget: 20ms (50 Hz)
MSL mode:     ~1.5ms used  â†’ âœ“ 92% headroom
MPC mode:     ~5ms used    â†’ âœ“ 75% headroom
```

---

## File Dependency Graph

```
                       SPGState.hpp
                            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚               â”‚               â”‚
            â–¼               â–¼               â–¼
      Target.hpp     Subtarget.hpp    Setpoint.hpp
            â”‚               â”‚               â”‚
            â–¼               â–¼               â–¼
      Target.cpp     Subtarget.cpp    Set.cpp â—„â”€â”€â”€â”€â”€â”€â”
            â”‚               â”‚          â”‚  â”‚          â”‚
            â”‚               â”‚          â”‚  â”‚          â”‚
            â”‚               â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”   â”‚
            â”‚               â”‚          â”‚         â”‚   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚
                                                 â”‚   â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                            â”‚                        â”‚
                            â–¼                        â”‚
                    HumanoidMPC.hpp                  â”‚
                            â”‚                        â”‚
                            â–¼                        â”‚
                    HumanoidMPC.cpp                  â”‚
                            â”‚                        â”‚
                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                        qpOASES
                    (external library)
```

---

**Want interactive diagrams?** The demo provides real-time visualization!
```bash
./demo_humanoid_mpc
```

**Need more details?** See:
- [`ARCHITECTURE.md`](ARCHITECTURE.md) - Full technical documentation
- [`QUICK_REFERENCE.md`](QUICK_REFERENCE.md) - Quick how-to guide
